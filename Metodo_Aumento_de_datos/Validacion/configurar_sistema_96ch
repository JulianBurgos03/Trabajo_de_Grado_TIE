function [fmdl_96ch, imdl_base_96ch] = configurar_sistema_96ch()
%CONFIGURAR_SISTEMA_96CH Crea sistema para 96 canales virtuales
%
% Sintaxis:
%   [fmdl_96ch, imdl_base_96ch] = configurar_sistema_96ch()
%
% Salidas:
%   fmdl_96ch - Modelo FEM configurado para 96 mediciones
%   imdl_base_96ch - Modelo inverso base

fprintf('   üîß Configurando sistema de 96 canales virtuales...\n');

%% PASO 1: Crear modelo FEM base de 16 electrodos
fmdl_base = crear_modelo_fem(16);

fprintf('      ‚úì fmdl base 16e: %d nodos, %d elementos, %d electrodos\n', ...
    size(fmdl_base.nodes, 1), size(fmdl_base.elems, 1), ...
    length(fmdl_base.electrode));

%% PASO 2: Construir patrones de estimulaci√≥n personalizados
n_electrodos = 16;
excitaciones_seleccionadas = 1:2:n_electrodos;  % [1,3,5,7,9,11,13,15]
n_mediciones_por_excitacion = 12;

fprintf('      üî® Construyendo patrones de estimulaci√≥n...\n');
fprintf('         Excitaciones: %d\n', length(excitaciones_seleccionadas));
fprintf('         Mediciones por excitaci√≥n: %d\n', n_mediciones_por_excitacion);

% Inicializar estructura de estimulaci√≥n
stim_pattern = struct([]);

for idx = 1:length(excitaciones_seleccionadas)
    elec_i = excitaciones_seleccionadas(idx);
    elec_j = mod(elec_i, n_electrodos) + 1;
    
    % Patr√≥n de corriente
    stim = zeros(n_electrodos, 1);
    stim(elec_i) = 1;
    stim(elec_j) = -1;
    
    stim_pattern(idx).stimulation = 'Amp';
    stim_pattern(idx).stim_pattern = stim;
    
    % Construir patr√≥n de medici√≥n
    meas_pat = [];
    
    for m = 1:n_mediciones_por_excitacion
        elec_m1 = mod(elec_j + m - 1, n_electrodos) + 1;
        elec_m2 = mod(elec_j + m, n_electrodos) + 1;
        
        meas = zeros(1, n_electrodos);
        meas(elec_m1) = 1;
        meas(elec_m2) = -1;
        
        meas_pat = [meas_pat; meas];
    end
    
    stim_pattern(idx).meas_pattern = meas_pat;
end

%% PASO 3: Crear nuevo fmdl con patrones personalizados
fmdl_96ch = fmdl_base;
fmdl_96ch.stimulation = stim_pattern;

% Eliminar meas_select si existe
if isfield(fmdl_96ch, 'meas_select')
    fmdl_96ch = rmfield(fmdl_96ch, 'meas_select');
end

% Asegurar tipo correcto
fmdl_96ch.type = 'fwd_model';

fprintf('      ‚úì Patrones configurados: %d estimulaciones\n', length(stim_pattern));

%% PASO 4: Verificar con simulaci√≥n
fprintf('      üîç Verificando configuraci√≥n...\n');

img_test = mk_image(fmdl_96ch, 1.0);
volt_test = fwd_solve(img_test);

n_meas = length(volt_test.meas);
fprintf('      ‚úì fwd_solve genera: %d mediciones\n', n_meas);

if n_meas ~= 96
    error('ERROR: Se esperaban 96 mediciones, se obtuvieron %d', n_meas);
end

%% PASO 5: Crear modelo inverso base
fprintf('      üî¨ Creando modelo inverso base...\n');

% Usar mk_common_model como plantilla
imdl_template = mk_common_model('c2c2', [16, 1]);

% Reemplazar el fwd_model
imdl_template.fwd_model = fmdl_96ch;

% Configurar b√°sico
imdl_template.hyperparameter.value = 1e-4;
imdl_template = select_imdl(imdl_template, {'Basic GN dif'});

% Asegurar tipo correcto
imdl_template.type = 'inv_model';

imdl_base_96ch = imdl_template;

fprintf('      ‚úÖ Sistema de 96 canales configurado correctamente\n');
fprintf('         Malla: 16 electrodos | Mediciones: 96 (8√ó12)\n');

end
